<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-Share Pro â€¢ å…¨æ™¯ç»ˆç«¯</title>
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <style>
        /* ================= è®¾è®¡ç³»ç»Ÿ ================= */
        :root {
            --bg-body: #f5f5f7;
            --bg-card: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent: #0071e3;
            --radius-box: 16px;
            --shadow-card: 0 4px 24px rgba(0,0,0,0.06);
            --red: #ff3b30;
            --green: #34c759;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding-bottom: 60px;
            -webkit-font-smoothing: antialiased;
        }

        /* ================= é¡¶éƒ¨å¯¼èˆªä¸å…¨å±€æœç´¢ ================= */
        .header-area {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            padding: 16px 0;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .brand { font-weight: 700; font-size: 20px; letter-spacing: -0.5px; }

        /* å…¨å±€æœç´¢æ¡† - æ ¸å¿ƒäº¤äº’ */
        .global-search-container {
            position: relative;
            width: 100%;
            max-width: 500px;
        }

        .global-search-input {
            width: 100%;
            padding: 12px 20px 12px 44px; /* å·¦è¾¹ç•™ç»™å›¾æ ‡ */
            font-size: 15px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            background: rgba(118, 118, 128, 0.12);
            color: var(--text-primary);
            outline: none;
            transition: all 0.2s;
            box-sizing: border-box; /* å…³é”®ï¼šé˜²æ­¢paddingæ’‘å¤§å®½åº¦ */
        }

        .global-search-input:focus {
            background: #fff;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        /* ================= åˆ†æ®µæ§åˆ¶å™¨ (Tabs) ================= */
        .tab-wrapper {
            margin-top: 10px;
        }

        .segmented-control {
            background: #e3e3e8;
            padding: 3px;
            border-radius: 8px;
            display: inline-flex;
        }

        .segment-btn {
            border: none;
            background: transparent;
            padding: 6px 24px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .segment-btn.active {
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-weight: 600;
        }

        /* ================= å†…å®¹å¡ç‰‡ ================= */
        .main-wrapper {
            max-width: 1400px;
            margin: 24px auto;
            padding: 0 24px;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-box);
            box-shadow: var(--shadow-card);
            padding: 4px; /* ç»™è¡¨æ ¼ç•™ä¸€ç‚¹è¾¹è· */
            overflow: hidden;
            display: none; /* é»˜è®¤éšè— */
            animation: fadeIn 0.3s ease;
        }

        .card.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: 0; } }

        /* ================= Grid.js å®šåˆ¶ ================= */
        .gridjs-container { font-family: inherit; color: var(--text-primary); }
        .gridjs-wrapper { box-shadow: none !important; border: none !important; }
        .gridjs-head { display: none; } /* éšè—Gridè‡ªå¸¦çš„æœç´¢æ¡†ï¼Œå› ä¸ºæˆ‘ä»¬ç”¨äº†å…¨å±€æœç´¢ */
        
        th.gridjs-th {
            background: #fbfbfd;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 12px;
        }

        td.gridjs-td {
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 10px 12px;
            font-size: 13px;
            vertical-align: middle;
        }

        /* ================= è¿·ä½ èµ°åŠ¿å›¾æ ·å¼ ================= */
        .trend-container {
            display: flex;
            align-items: center;
            height: 50px;
        }
        .trend-labels {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            font-size: 10px;
            color: var(--text-secondary);
            margin-right: 8px;
            text-align: right;
            width: 30px;
        }
        .trend-svg-box { flex: 1; }
        .trend-text { font-size: 9px; fill: var(--text-secondary); font-weight: 500; }

        /* æ¶¨è·Œé¢œè‰² */
        .text-up { color: var(--red); font-weight: 600; }
        .text-down { color: var(--green); font-weight: 600; }
        .bg-up-light { background: rgba(255, 59, 48, 0.08); padding: 2px 6px; border-radius: 4px; }
        .bg-down-light { background: rgba(52, 199, 89, 0.08); padding: 2px 6px; border-radius: 4px; }

    </style>
</head>
<body>

    <header class="header-area">
        <div class="header-content">
            <div class="brand">A-Share Data Pro</div>
            
            <div class="global-search-container">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="globalSearch" class="global-search-input" placeholder="è¾“å…¥ä»£ç  (600519) æˆ–åç§° (èŒ…å°) æœç´¢...">
            </div>

            <div class="tab-wrapper">
                <div class="segmented-control">
                    <button class="segment-btn active" onclick="switchModule('basic')">åŸºç¡€è¡Œæƒ… & è¶‹åŠ¿</button>
                    <button class="segment-btn" onclick="switchModule('finance')">è´¢åŠ¡æ ¸å¿ƒæŒ‡æ ‡ (æŒ‰å­£åº¦)</button>
                </div>
            </div>
        </div>
    </header>

    <main class="main-wrapper">
        <div id="module-basic" class="card active">
            <div id="grid-basic"></div>
        </div>

        <div id="module-finance" class="card">
            <div id="grid-finance"></div>
        </div>
    </main>

    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    <script>
        // å…¨å±€å˜é‡å­˜å‚¨æ•°æ®å’Œè¡¨æ ¼å®ä¾‹
        let ALL_DATA = [];
        let gridBasic = null;
        let gridFinance = null;

        // ================= å·¥å…·å‡½æ•° =================

        // åˆ‡æ¢æ¨¡å—
        window.switchModule = function(moduleName) {
            // æŒ‰é’®æ ·å¼
            document.querySelectorAll('.segment-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById(`module-${moduleName}`).classList.add('active');

            // å¼ºåˆ¶åˆ·æ–°è¡¨æ ¼å¸ƒå±€ (ä¿®å¤åˆ‡æ¢æ—¶è¡¨å¤´é”™ä½)
            window.dispatchEvent(new Event('resize'));
        }

        // ç”Ÿæˆå¸¦æ ‡æ³¨çš„æŠ˜çº¿å›¾ (Sparkline V2)
        function generateProSparkline(values) {
            if (!values || values.length < 2) return '<span style="color:#ddd">æš‚æ— èµ°åŠ¿</span>';

            const width = 140;
            const height = 40;
            const padding = 5; // å†…è¾¹è·ï¼Œé˜²æ­¢æå€¼é¡¶åˆ°è¾¹æ¡†
            
            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min || 1;
            
            const startPrice = values[0];
            const endPrice = values[values.length - 1];
            const isUp = endPrice >= startPrice;
            const color = isUp ? '#ff3b30' : '#34c759';

            // ç”Ÿæˆè·¯å¾„ç‚¹
            const points = values.map((val, i) => {
                const x = (i / (values.length - 1)) * width;
                // ç•™å‡º padding ç©ºé—´
                const y = (height - padding) - ((val - min) / range) * (height - 2 * padding);
                return `${x},${y}`;
            }).join(' ');

            return `
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:10px; color:#888; width:30px; text-align:right;">${startPrice.toFixed(1)}</span>
                    <svg width="${width}" height="${height}" style="overflow:visible">
                        <polyline points="${points}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="${width}" cy="${(height - padding) - ((endPrice - min) / range) * (height - 2 * padding)}" r="2.5" fill="${color}" />
                    </svg>
                    <span style="font-size:10px; color:${color}; font-weight:600; width:35px;">${endPrice.toFixed(1)}</span>
                </div>
            `;
        }

        // ================= æ ¸å¿ƒé€»è¾‘ =================

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const res = await fetch('./data.json');
                ALL_DATA = await res.json();
                
                if (!ALL_DATA || ALL_DATA.length === 0) return;

                // 1. æ•°æ®é¢„å¤„ç†ï¼šæå–æ‰€æœ‰å¯ç”¨çš„æ—¥æœŸåˆ— (ç”¨äºè´¢åŠ¡æ¨¡å—)
                const allKeys = Object.keys(ALL_DATA[0]);
                
                // æå– "2024-09-30_EPS" è¿™ç§æ ¼å¼ä¸­çš„æ—¥æœŸéƒ¨åˆ†
                const dateSet = new Set();
                const trendKeys = []; // ç”¨äºåŸºç¡€è¡Œæƒ…çš„å‡ä»·

                allKeys.forEach(key => {
                    if (key.includes('_å‡ä»·')) trendKeys.push(key);
                    // åŒ¹é… YYYY-MM-DD æ ¼å¼
                    const match = key.match(/(\d{4}-\d{2}-\d{2})/);
                    if (match) dateSet.add(match[1]);
                });

                // å¯¹æ—¥æœŸå€’åºæ’åˆ—ï¼Œå–æœ€è¿‘çš„4ä¸ªå­£åº¦
                const sortedDates = Array.from(dateSet).sort().reverse().slice(0, 4);
                trendKeys.sort(); // å‡ä»·æŒ‰æ—¶é—´æ­£åº

                // 2. åˆå§‹åŒ– åŸºç¡€è¡Œæƒ…è¡¨æ ¼
                gridBasic = new gridjs.Grid({
                    data: ALL_DATA,
                    columns: [
                        { id: 'ä»£ç ', name: 'ä»£ç ', width: '80px' },
                        { id: 'åç§°', name: 'åç§°', width: '90px' },
                        { 
                            id: 'æœ€æ–°ä»·', name: 'æœ€æ–°ä»·', width: '80px',
                            formatter: (cell) => gridjs.html(`<b>${cell}</b>`)
                        },
                        {
                            name: 'è¿‘ä¸€å¹´èµ°åŠ¿ (å§‹/ç»ˆ)',
                            width: '240px',
                            sort: false,
                            formatter: (_, row) => {
                                // åŠ¨æ€ä»è¡Œæ•°æ®ä¸­æå–å‡ä»·
                                // row.cells æ˜¯å½“å‰åˆ—çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åŸå§‹æ•°æ®
                                // è¿™é‡Œä½¿ç”¨ä¸€ä¸ªå°æŠ€å·§ï¼šåŒ¹é…å½“å‰ä»£ç 
                                const stockCode = row.cells[0].data;
                                const stockData = ALL_DATA.find(d => d['ä»£ç '] === stockCode);
                                if(!stockData) return '';

                                const prices = trendKeys.map(k => parseFloat(stockData[k])).filter(n => !isNaN(n));
                                return gridjs.html(generateProSparkline(prices));
                            }
                        },
                        { 
                            id: 'æ¶¨è·Œå¹…%', name: 'æ¶¨è·Œå¹…', width: '90px',
                            formatter: (cell) => {
                                const val = parseFloat(cell);
                                if(isNaN(val)) return '-';
                                const cls = val > 0 ? 'bg-up-light text-up' : (val < 0 ? 'bg-down-light text-down' : '');
                                return gridjs.html(`<span class="${cls}">${cell}%</span>`);
                            }
                        },
                        { id: 'æ€»å¸‚å€¼(ä¸‡)', name: 'å¸‚å€¼(ä¸‡)', width: '100px' },
                        { id: 'å¸‚ç›ˆç‡(åŠ¨)', name: 'PE(åŠ¨)', width: '80px' },
                        { id: 'æ¢æ‰‹ç‡%', name: 'æ¢æ‰‹ç‡', width: '80px' }
                    ],
                    pagination: { limit: 15 },
                    fixedHeader: true,
                    height: '70vh',
                    style: { table: { 'white-space': 'nowrap' } }
                }).render(document.getElementById("grid-basic"));


                // 3. åˆå§‹åŒ– è´¢åŠ¡æŒ‡æ ‡è¡¨æ ¼ (åŠ¨æ€ç”Ÿæˆå­£åº¦åˆ—)
                
                // æ„å»ºåˆ—é…ç½®ï¼šå‰ä¸¤åˆ—å›ºå®šï¼Œåé¢æŒ‰å­£åº¦å¾ªç¯
                const financeColumns = [
                    { id: 'ä»£ç ', name: 'ä»£ç ', width: '80px', fixed: true },
                    { id: 'åç§°', name: 'åç§°', width: '90px', fixed: true }
                ];

                // éå†æœ€è¿‘4ä¸ªå­£åº¦ï¼ŒåŠ¨æ€æ·»åŠ åˆ—
                // ç¤ºä¾‹ï¼š2024-09-30 -> æ˜¾ç¤ºä¸º "24Q3"
                sortedDates.forEach(date => {
                    const year = date.substring(2, 4);
                    const month = parseInt(date.substring(5, 7));
                    const quarter = Math.ceil(month / 3);
                    const label = `${year}Q${quarter}`; // ä¾‹å¦‚ 24Q3

                    // ä¸ºæ¯ä¸ªå­£åº¦æ·»åŠ æ ¸å¿ƒæŒ‡æ ‡åˆ—
                    financeColumns.push(
                        { 
                            id: `${date}_EPS`, 
                            name: `${label} EPS`, 
                            width: '90px',
                            formatter: (cell) => cell ? parseFloat(cell).toFixed(3) : '-'
                        },
                        { 
                            id: `${date}_ROE`, 
                            name: `${label} ROE`, 
                            width: '90px',
                            formatter: (cell) => cell ? `${parseFloat(cell).toFixed(2)}%` : '-'
                        },
                        { 
                            id: `${date}_å‡€åˆ©`, 
                            name: `${label} å‡€åˆ©`, 
                            width: '100px',
                            formatter: (cell) => cell ? (parseFloat(cell)/100000000).toFixed(2)+'äº¿' : '-'
                        }
                    );
                });

                gridFinance = new gridjs.Grid({
                    data: ALL_DATA,
                    columns: financeColumns,
                    pagination: { limit: 15 },
                    fixedHeader: true,
                    height: '70vh',
                    style: { table: { 'white-space': 'nowrap' } }
                }).render(document.getElementById("grid-finance"));


                // 4. ç»‘å®šå…¨å±€æœç´¢äº‹ä»¶ (é«˜æ€§èƒ½è¿‡æ»¤)
                const searchInput = document.getElementById('globalSearch');
                
                searchInput.addEventListener('input', function(e) {
                    const keyword = e.target.value.toLowerCase().trim();
                    
                    // è¿‡æ»¤æ•°æ®
                    const filtered = ALL_DATA.filter(item => 
                        (item['ä»£ç '] && item['ä»£ç '].includes(keyword)) ||
                        (item['åç§°'] && item['åç§°'].toLowerCase().includes(keyword))
                    );

                    // åŒæ—¶æ›´æ–°ä¸¤ä¸ªè¡¨æ ¼çš„æ•°æ®é…ç½®
                    // æ³¨æ„ï¼šupdateConfig æ¯”è¾ƒè½»é‡ï¼ŒforceRender è§¦å‘é‡ç»˜
                    gridBasic.updateConfig({ data: filtered }).forceRender();
                    gridFinance.updateConfig({ data: filtered }).forceRender();
                });

            } catch (error) {
                console.error("åŠ è½½å¤±è´¥:", error);
                document.querySelector('.main-wrapper').innerHTML = `<h3 style="text-align:center; margin-top:50px; color:#888;">æ•°æ®åŠ è½½ä¸­æˆ–å‘ç”Ÿé”™è¯¯...<br><small>${error}</small></h3>`;
            }
        });
    </script>
</body>
</html>